# Повторяющиеся задачи

В этом файле документируются повторяющиеся задачи и их рабочие процессы.

## Добавление нового вида спорта

**Когда требуется**: Добавление поддержки нового вида спорта (например, Cricket, Rugby)

**Файлы для изменения**:
- `app/betexplorer/schemas.py` - Добавить новый вид спорта в `SportType` enum
- `app/betexplorer/schemas.py` - Добавить URL для нового вида спорта в `sports_url` словарь
- `app/betexplorer/schemas.py` - Добавить описание нового вида спорта в `SPORTS` список
- `app/config_new.py` - Добавить новый вид спорта в `SPORT_TYPE` список (если нужно по умолчанию)

**Шаги**:
1. Добавить новый enum значение в `SportType` с уникальным числовым идентификатором
2. Добавить URL путь для нового вида спорта в `sports_url` словарь
3. Добавить описание нового вида спорта в `SPORTS` список с тем же идентификатором
4. При необходимости добавить вид спорта в конфигурацию по умолчанию

**Важные замечания**:
- Идентификатор должен быть уникальным и не конфликтовать с существующими
- URL должен соответствовать структуре BetExplorer.com
- Проверить, что новый вид спорта поддерживается на сайте BetExplorer

## Добавление новой таблицы в базу данных

**Когда требуется**: Добавление новой сущности для хранения данных (например, таблица для статистики игроков)

**Файлы для изменения**:
- `app/betexplorer/models.py` - Создать новую модель SQLAlchemy
- `app/betexplorer/crud.py` - Добавить CRUD операции для новой таблицы
- `app/betexplorer/schemas.py` - Добавить TypedDict для структуры данных (если нужно)

**Шаги**:
1. Создать новый класс модели, наследующий от `Base`
2. Определить все поля с правильными типами и комментариями
3. Добавить внешние ключи и индексы при необходимости
4. Добавить связи (relationships) с другими моделями
5. Создать методы CRUD в `CRUDbetexplorer` классе
6. Добавить TypedDict схему для типизации данных (если нужно)

**Важные замечания**:
- Использовать `Mapped` типы для полей
- Добавлять комментарии на русском языке для документации
- Учитывать режимы работы базы данных (DATABASE_NOT_USE, DATABASE_READ_ONLY, DATABASE_WRITE_DATA)
- Для PostgreSQL использовать `Identity(start=1)` для автоинкрементных полей

## Добавление нового типа события матча

**Когда требуется**: Добавление поддержки новых типов ставок (например, "точный счет", "первый гол")

**Файлы для изменения**:
- `app/betexplorer/schemas.py` - Добавить новый константу для типа события
- `app/betexplorer/betexplorer.py` - Добавить функцию парсинга для нового типа события
- `app/betexplorer/betexplorer.py` - Интегрировать парсинг в `get_match_line()` функцию

**Шаги**:
1. Добавить новую константу (например, `EVENT_EXACT_SCORE`)
2. Создать функцию парсинга для нового типа события
3. Добавить вызов функции парсинга в `get_match_line()` с соответствующими условиями
4. Обновить схему `MatchEventBetexplorer` если нужны дополнительные поля

**Важные замечания**:
- Проверить структуру HTML на BetExplorer.com для нового типа события
- Учесть, что не все типы событий доступны для всех видов спорта
- Добавить обработку ошибок при отсутствии данных

## Обновление конфигурации для новой среды

**Когда требуется**: Развертывание проекта в новой среде (например, staging, production)

**Файлы для изменения**:
- `app/config_new.py` - Обновить параметры подключения и пути

**Шаги**:
1. Изменить `SQLALCHEMY_DATABASE_URI` на новую базу данных
2. Обновить `DOWNLOAD_DIRECTORY` на путь для новой среды
3. Обновить `FBCUP_DIRECTORY` на путь для вывода результатов
4. При необходимости изменить `CONFIG_DATABASE` параметры
5. Установить правильный режим работы (`SAVE_DATABASE`)

**Важные замечания**:
- Убедиться, что база данных существует и доступна
- Создать необходимые директории перед запуском
- Проверить права доступа к файловой системе

## Добавление теста для нового функционала

**Когда требуется**: Добавление тестового покрытия для новых функций или модулей

**Файлы для изменения**:
- `app/tests/test_*.py` - Создать новый тестовый файл или добавить в существующий
- `app/tests/download/betexplorer/` - Добавить тестовые данные (если нужно)

**Шаги**:
1. Создать новый тестовый файл с именем `test_<module>.py`
2. Импортировать необходимые функции и классы
3. Написать тестовые функции с использованием pytest
4. Добавить фикстуры для подготовки тестовых данных
5. Добавить тестовые HTML файлы в директорию `download/betexplorer/` (если нужно)

**Важные замечания**:
- Использовать `pytest-asyncio` для асинхронных тестов
- Следовать соглашениям об именовании тестов: `test_<functionality>`
- Использовать `@pytest.mark.parametrize` для параметризованных тестов
- Добавлять docstrings для описания назначения теста

## Оптимизация загрузки данных

**Когда требуется**: Ускорение процесса загрузки для большого количества данных

**Файлы для изменения**:
- `app/betexplorer/betexplorer.py` - Оптимизировать функции парсинга
- `app/betexplorer/crud.py` - Оптимизировать CRUD операции
- `app/config_new.py` - Настроить количество процессов

**Шаги**:
1. Профилировать код для выявления узких мест
2. Оптимизировать SQL запросы (добавить индексы, оптимизировать JOIN)
3. Увеличить количество процессов в `PROCESSES` (если позволяет CPU)
4. Использовать bulk operations для массовой вставки данных
5. Оптимизировать парсинг HTML (использовать более эффективные селекторы)

**Важные замечания**:
- Не забывать про ограничения BetExplorer.com (не перегружать сервер)
- Учитывать ограничения базы данных (максимальное количество соединений)
- Проверять использование памяти при увеличении количества процессов
- Тестировать изменения на небольшом наборе данных перед запуском на полном объеме

## Обработка ошибок при загрузке

**Когда требуется**: Улучшение обработки ошибок и устойчивости системы

**Файлы для изменения**:
- `app/betexplorer/betexplorer.py` - Добавить обработку ошибок в функции загрузки
- `app/utilbase.py` - Улучшить обработку сетевых ошибок

**Шаги**:
1. Добавить try-except блоки для критических операций
2. Логировать ошибки с детальной информацией
3. Добавить механизмы повторных попыток (retry logic)
4. Обработать специфические исключения (TimeoutError, ConnectionError)
5. Добавить валидацию данных перед сохранением

**Важные замечания**:
- Не скрывать критические ошибки
- Логировать достаточно информации для диагностики
- Предусмотреть graceful degradation (продолжение работы при некритических ошибках)
- Добавить уведомления о критических ошибках
